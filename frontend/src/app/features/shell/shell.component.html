<div class="app-shell" *ngIf="store.property$ | async as property">
  <header class="topbar">
    <nav class="tabs">
      <a routerLink="/property-details" routerLinkActive="active">Property Details</a>
      <a routerLink="/underwriting" routerLinkActive="active">Underwriting</a>
    </nav>

    <div class="actions">
      <select #versionSelect class="version-select" [value]="property.version" (change)="onVersionChange(versionSelect.value, $event)">
        <option *ngFor="let item of store.versions$ | async" [value]="item.version">
          {{ item.version }}{{ item.isHistorical ? ' (Historical)' : '' }}
        </option>
      </select>
      <button type="button" class="btn btn-primary" [disabled]="property.isHistorical || !(store.isDirty$ | async)" (click)="onSave()">Save</button>
      <button type="button" class="btn btn-soft" [disabled]="property.isHistorical || !(store.isDirty$ | async)" (click)="onSaveAs()">Save As</button>
    </div>
  </header>

  <section class="error-banner" *ngIf="errorMessage">
    {{ errorMessage }}
  </section>

  <section class="success-banner" *ngIf="successMessage">
    {{ successMessage }}
  </section>

  <section class="validation-banner" *ngIf="validationErrors.length > 0">
    <div *ngFor="let error of validationErrors">{{ error }}</div>
  </section>

  <main>
    <router-outlet></router-outlet>
  </main>

  <section class="history-card">
    <h3>Change History</h3>
    <div class="history-empty" *ngIf="(store.auditLogs$ | async)?.length === 0">No history entries for this version yet.</div>
    <div class="history-table-wrap" *ngIf="(store.auditLogs$ | async) as logs">
      <table *ngIf="logs.length > 0">
        <thead>
          <tr>
            <th>When</th>
            <th>Action</th>
            <th>User</th>
            <th>Fields Updated</th>
            <th>Changes</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let log of logs; trackBy: trackByAuditLog">
            <td>{{ log.createdAt | date: 'M/d/y, h:mm a' }}</td>
            <td>{{ log.action }}</td>
            <td>{{ log.updatedBy }}</td>
            <td>{{ log.changedFieldCount }}</td>
            <td class="changes-cell">
              <div *ngFor="let change of log.changes">{{ formatAuditChange(change) }}</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</div>

<div class="app-shell loading-shell" *ngIf="!(store.property$ | async)">
  <section class="error-banner" *ngIf="errorMessage">{{ errorMessage }}</section>
  <section class="loading-text" *ngIf="!errorMessage">Loading property data...</section>
</div>
